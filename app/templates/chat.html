{% extends 'base.html' %}
{% block content %}

<div class="wa-chat-card">

    <!-- HEADER -->
    <div class="wa-header">
        <div class="wa-avatar">
            {{ other_user.username|first|upper }}
        </div>

        <div>
            <div class="wa-name">{{ other_user.username }}</div>
            <small id="user-status"
                   class="{% if other_user.is_online %}online{% else %}offline{% endif %}">
                {% if other_user.is_online %}Online{% else %}Offline{% endif %}
            </small>
            <div id="typing-indicator" style="display:none;font-size:13px;color:#aaa;">
                typing...
            </div>
        </div>
    </div>

    <!-- CHAT BODY -->
    <div id="chat-box" class="wa-chat-body">
        {% for msg in messages %}
        <div class="wa-message-row {% if msg.sender == user %}sent{% else %}received{% endif %}"
             data-id="{{ msg.id }}">
            <div class="wa-bubble">
                {{ msg.content|escape }}
                <span class="wa-time">
                    {{ msg.timestamp|time:"H:i" }}
                    {% if msg.sender == user %}
                    <span class="tick" data-msg="{{ msg.id }}">
                        {% if msg.is_read %}âœ“âœ“{% else %}âœ“{% endif %}
                    </span>
                    {% endif %}
                </span>
            </div>

            {% if msg.sender == user %}
            <button class="delete-btn" data-id="{{ msg.id }}">ðŸ—‘</button>
            {% endif %}
        </div>
        {% endfor %}
    </div>

    <!-- INPUT -->
    <form id="chat-form" class="wa-input-area">
        <input id="msg" placeholder="Type a message..." autocomplete="off">
        <button type="submit">âž¤</button>
    </form>

</div>

<!-- DELETE POPUP -->
<div id="deleteModal" class="delete-modal">
    <div class="delete-box">
        <p>Delete this message?</p>
        <div class="delete-actions">
            <button id="cancelDelete">Cancel</button>
            <button id="confirmDelete">Delete</button>
        </div>
    </div>
</div>

<script>
const box = document.getElementById("chat-box");
const input = document.getElementById("msg");
const typingBox = document.getElementById("typing-indicator");
const statusText = document.getElementById("user-status");

const deleteModal = document.getElementById("deleteModal");
const confirmDelete = document.getElementById("confirmDelete");
const cancelDelete = document.getElementById("cancelDelete");

let deleteId = null;

function scrollBottom(){
    box.scrollTop = box.scrollHeight;
}

const wsScheme = location.protocol === "https:" ? "wss" : "ws";

/* ================= CHAT SOCKET ================= */

const chatSocket = new WebSocket(
    wsScheme + "://" + location.host + "/ws/chat/{{ other_user.id }}/"
);

chatSocket.onopen = () => {
    scrollBottom();
    markRead();
};

chatSocket.onmessage = e => {
    const data = JSON.parse(e.data);

    if(data.type === "message"){
        const side = data.sender_id == {{ user.id }} ? "sent" : "received";

        let html = `
        <div class="wa-message-row ${side}" data-id="${data.message_id}">
            <div class="wa-bubble">
                ${escapeHTML(data.message)}
                <span class="wa-time">${formatTime(data.timestamp)}`;

        if(side === "sent"){
            html += `<span class="tick" data-msg="${data.message_id}">âœ“</span>`;
        }

        html += `</span></div>`;

        if(side === "sent"){
            html += `<button class="delete-btn" data-id="${data.message_id}">ðŸ—‘</button>`;
        }

        html += `</div>`;

        box.insertAdjacentHTML("beforeend", html);
        scrollBottom();

        if(side === "received"){
            chatSocket.send(JSON.stringify({
                type:"mark_as_read",
                message_ids:[data.message_id]
            }));
        }

        typingBox.style.display="none";
    }

    if(data.type === "read"){
        data.message_ids.forEach(id=>{
            const tick=document.querySelector(`[data-msg="${id}"]`);
            if(tick) tick.textContent="âœ“âœ“";
        });
    }

    if(data.type === "typing"){
        typingBox.style.display="block";
    }

    if(data.type === "stop_typing"){
        typingBox.style.display="none";
    }

    if(data.type === "deleted"){
        const el=document.querySelector(`[data-id="${data.message_id}"]`);
        if(el) el.remove();
    }
};

/* ================= SEND MESSAGE ================= */

document.getElementById("chat-form").onsubmit=e=>{
    e.preventDefault();

    const text=input.value.trim();
    if(!text) return;

    chatSocket.send(JSON.stringify({
        type:"message",
        message:text
    }));

    input.value="";
    typingBox.style.display="none";
};

/* ================= TYPING ================= */

let typing=false;
let timer;

input.addEventListener("input",()=>{
    if(!typing){
        typing=true;
        chatSocket.send(JSON.stringify({type:"typing"}));
    }

    clearTimeout(timer);
    timer=setTimeout(()=>{
        typing=false;
        chatSocket.send(JSON.stringify({type:"stop_typing"}));
    },1000);
});

/* ================= DELETE POPUP ================= */

box.addEventListener("click", e=>{
    if(e.target.closest(".delete-btn")){
        deleteId = e.target.closest(".delete-btn").dataset.id;
        deleteModal.style.display="flex";
    }
});

confirmDelete.onclick = () => {
    chatSocket.send(JSON.stringify({
        type:"delete_message",
        message_id: deleteId
    }));
    deleteModal.style.display="none";
};

cancelDelete.onclick = () => {
    deleteModal.style.display="none";
};

/* ================= PRESENCE ================= */

const presenceSocket = new WebSocket(
    wsScheme + "://" + location.host + "/ws/presence/"
);

presenceSocket.onmessage = e=>{
    const data = JSON.parse(e.data);
    if(data.type==="presence" && data.user_id == {{ other_user.id }}){
        statusText.textContent = data.is_online ? "Online" : "Offline";
        statusText.className = data.is_online ? "online" : "offline";
    }
};

/* ================= UTIL ================= */

function markRead(){
    const unread=document.querySelectorAll(".received[data-id]");
    const ids=[...unread].map(el=>el.dataset.id);
    if(ids.length){
        chatSocket.send(JSON.stringify({
            type:"mark_as_read",
            message_ids:ids
        }));
    }
}

function formatTime(iso){
    const date=new Date(iso);
    return date.toLocaleTimeString("en-IN",{
        hour:"2-digit",
        minute:"2-digit",
        hour12:false,
        timeZone:"Asia/Kolkata"
    });
}

function escapeHTML(text){
    const div=document.createElement("div");
    div.textContent=text;
    return div.innerHTML;
}

// Close presence socket when user leaves this page (navigate away, close tab, etc)
window.addEventListener('beforeunload', () => {
    if (presenceSocket && presenceSocket.readyState === WebSocket.OPEN) {
        presenceSocket.close();
    }
});

// Also handle page hide (when switching tabs, etc)
window.addEventListener('pagehide', () => {
    if (presenceSocket && presenceSocket.readyState === WebSocket.OPEN) {
        presenceSocket.close();
    }
});

scrollBottom();
</script>

{% endblock %}
